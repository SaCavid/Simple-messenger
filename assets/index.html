{{define "content"}}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test app</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">

</head>
<body>

<div class="container">

    <div class="card">
        <div class="card-header">
            <h5>Chat app</h5>
        </div>
        <div class="card-body">
            <div id="chatUser" class="card-title">

            </div>

            <div class="row login">
                <div class="col-md-4">

                    <div class="form-group">
                        <label for="usernameInput">Username </label>
                        <input type="text" class="form-control" id="usernameInput" aria-describedby="usernameHelp"
                               placeholder="Enter Username" value="WsUser">
                        <small id="usernameHelp" class="form-text text-muted">Simple information for
                            identification.</small>
                    </div>
                    <button type="submit" class="btn btn-primary" onclick="WebSocketTest()">Connect to websocket
                    </button>
                </div>
            </div>
            <button class="btn btn-danger" onclick="addTab()">Add</button>
            <div class="row">
                <div class="col-4">
                    <div class="list-group" id="list-tab" role="tablist">

                    </div>
                </div>
                <div class="col-8">
                    <div class="tab-content" id="nav-tabContent">

                    </div>
                </div>
            </div>
            <div class="row chat">

                <div id="usersList" class="col-md-3">

                </div>
                <div class="col-md-9 messages">
                    <div class="card">
                        <div id="receiverUser" class="card-header">
                            <h5>Username</h5>
                        </div>

                        <div id="messages" class="card-body" style="height: 300px; overflow-y: scroll">

                        </div>
                        <div class="card-footer">
                            <div class="input-group mb-3">
                                <input id="message" type="text" class="form-control" placeholder="Enter message"
                                       aria-label="Enter message" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="sendMessage()"><i
                                            class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script>
    let Username = "";
    let Receiver = "";
    let Messages = [];
    let Users = [];
    let Ws;

    $(".chat").hide();

    function addTab(d) {

        let active = "";
        if (Receiver === "" || Receiver === undefined) {
            active = 'active'
        }
        
        $("#list-tab").append(`<a class="list-group-item list-group-item-action ` + active + `" id="list-` + d + `-list" data-toggle="list" href="#list-` + d + `" role="tab" aria-controls="home">
                            <div class="d-flex w-100 justify-content-between">
                                Home ` + d + `
                                <small>3 days ago</small>
                            </div></a>`);
        $("#nav-tabContent").append(`<div class="tab-pane fade show ` + active + `" id="list-` + d + `" role="tabpanel"
                             aria-labelledby="list-` + d + `-list">
                            <div class="card">
                                <div class="card-header">
                                    ` + d + `
                                </div>
                                <div class="card-body">
                                    Body
                                </div>
                                <div class="card-footer">
                                    <div class="input-group mb-3">
                                        <input id="` + d + `Message" type="text" class="form-control" placeholder="Enter message"
                                               aria-label="Enter message" aria-describedby="basic-addon2">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="sendMessage(` + d + `)"><i
                                                    class="fas fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`);
    }

    function sendMessage() {
        let m = $("#message").val();

        let message = {
            "From": Username,
            "To": Receiver,
            "Data": m
        }

        if (message.From === "" || message.To === "") {
            Notification("error", "Error with simple app. Please refresh page.")
            return
        }

        if (message.Data === "") {
            Notification("warning", "No message input")
            return
        }

        Messages.push(message)
        if (Messages.length > 250) {
            Messages.slice(Messages.length - 251, Messages.length - 1);
        }

        message = JSON.stringify(message)
        Ws.send(message)

        listMessages();
        $("#message").val("")
    }

    function WebSocketTest() {

        if ("WebSocket" in window) {
            console.log("WebSocket is supported by your Browser!");

            let username = $("#usernameInput").val()

            if (username === "") {
                Notification("error", "Username cant be null. Please fill username input!")
                return
            }


            Username = username

            // for simple login process
            let openingMessage = {
                "From": Username,
                "To": Username,
                "Data": "",
            }

            // Let us open a web socket
            let ws = new WebSocket("ws://localhost:80/ws");
            Ws = ws;
            ws.onopen = function () {
                $(".login").hide();
                $(".chat").show();

                // Web Socket is connected, send data using send()
                Notification("success", "Connected to websocket")
                openingMessage = JSON.stringify(openingMessage)
                ws.send(openingMessage)
            };

            ws.onmessage = function (e) {

                let data = JSON.parse(e.data)
                Messages.push(data)
                if (data.From === "Server" && data.To === "All") {


                    listUsers(data.Users)
                }
                listMessages();
            };

            ws.onclose = function () {

                Notification("warning", "Websocket disconnected")
                $(".login").show()
                $(".chat").hide()

            };

            ws.onerror = function () {
                Notification("error", "Websocket disconnected")
            };

        } else {

            // The browser doesn't support WebSocket
            console.log("WebSocket NOT supported by your Browser!");
        }
    }

    function listUsers(users) {
        let active = false;
        let html = `<ul class="list-group">`;
        for (let i = 0; i < users.length; i++) {
            if (users[i] !== Username) {
                if (!active) {
                    Receiver = users[i];
                    $("#receiverUser").html("<h5>" + Receiver + "</h5>")
                    html = html + `<li class="list-group-item list-group-item-action active" onclick="selectUser(this)">` + users[i] + `</li> `
                    active = true
                } else {
                    html = html + `<li class="list-group-item list-group-item-action" onclick="selectUser(this)">` + users[i] + `</li> `
                }
            } else {
                let usersCount = users.length - 1
                $("#chatUser").html("<h5>Online : " + usersCount + " users</h5>");
            }
        }
        html = html + `</ul>`;

        $("#usersList").html(html);

    }

    function selectUser(d) {
        $("#usersList ul li").removeClass("active")
        $(d).addClass("active")

        Receiver = $(d).text();
        $("#receiverUser").html("<h5>" + Receiver + "</h5>")
        listMessages()
    }

    function listMessages() {
        $("#messages").html('')


        for (let i = 0; i < Messages.length; i++) {
            let message = Messages[i]
            if (message.From === Receiver || message.To === Receiver) {
                if (message.From === Username) {
                    $("#messages").append(`</br><div class="message float-right"><span>` + message.Data + `</span></div>`)

                }

                if (message.To === Username) {

                    $("#messages").append(`</br><div class="message"><span>` + message.Data + `</span></div>`);

                }
                // $('#messages ').last()[0].scrollIntoView();
                let myDiv = document.getElementById("messages");
                myDiv.scrollTop = myDiv.scrollHeight;
            }
        }
    }

    function Notification(s, msg) {
        toastr[s](msg)

        toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": true,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }
    }
</script>
</body>
</html>
{{end}}
